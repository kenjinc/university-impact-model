---
title: "Data Cleaning and Aggregation"
output: github_document
date: "Last updated: April 29, 2024"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Package Loading

```{r}
library(tidyverse)
library(ggpubr)
```
## Data Loading

There are three principal data inputs needed to generate our impact model:

* Shape-File Data
* Dietary-Footprint Data
* University-Enrollment Data

The shape-file data we will be using, which is local to the `maps` package within the `tidyverse` collection, can be written into the `parent-files` folder of our respository with the following: 

```{r}
shapefile_data <- map_data("world")
write.csv(shapefile_data,file="/Users/kenjinchang/github/university-impact-model/data/parent-files/shapefile_data_by_country.csv")
```

With the shape-file data now archived, we can  move on to loading in the remaining two data inputs. These include (1) the publication data from "Country-specific dietary shifts to mitigate climate and water crises" (Kim et al., 2020), which was retrieved via the Digital Commons using this [ link](https://data.mendeley.com/datasets/g8n8w8snmj/3), and (2) the customized indicator report created on April 19, 2024 from the [EdStats database](https://databank.worldbank.org/reports.aspx?source=Education%20Statistics).

```{r}
dietary_footprint_data <- read.csv("/Users/kenjinchang/github/university-impact-model/data/parent-files/dietary_footprints_by_country.csv")
university_enrollment_data <- read.csv("/Users/kenjinchang/github/university-impact-model/data/parent-files/education_data_by_country.csv")
```


```{r}
climate_footprint_data <- read.csv("/Users/kenjinchang/github/university-impact-model/data/parent-files/dietary_footprints_by_country.csv")
```

Before synthesizing the relevant information from these individual inputs into a single data file, we will first need to make a series of adjustments in preparation for our spatial join. In the following sections, we document these steps, their motivations, and the code chunks used to transform them.

## Adjusting the Shape-File Data

Because the directory of nation-states used in the `maps` package does not correspond with the country designations used in the remaining two data sources, we will need to adjust how these areas are geographically and politically represented within our shape-file data.

To ensure consistency in naming, as well as the spatial boundaries used to represent these areas, across three leveraged data sources, we will follow the conventions outlined by the [International Organizaation for Standardization (ISO)](https://www.iso.org/iso-3166-country-codes.html).

Following the instructions provided by Thomas Haslam in his 2021 [RPubs entry](https://rpubs.com/Thom_JH/798825), we will begin this process by first addressing what he refers to as the "easy cases."

These cases refer to the 13 instances where the names of the nation-states listed under the `region` variable in the `maps` package are misaligned with the names of the nation-states listed under the `country` variable in the `Gapminder` datasetâ€”a commonly used data source that happens to be synchronized with [ISO-3166 naming standards](https://www.iso.org/iso-3166-country-codes.html). 

```{r}
shapefile_data <- shapefile_data %>% 
  rename(country=region) %>%
  mutate(country=case_when(country=="Macedonia"~"North Macedonia",
                           country=="Ivory Coast"~"Cote d'Ivoire",
                           country=="Democratic Republic of the Congo"~"Congo, Dem. Rep.",
                           country=="Republic of Congo"~"Congo, Rep.",
                           country=="UK"~"United Kingdom",
                           country=="USA"~"United States",
                           country=="Laos"~"Lao",
                           country=="Slovakia"~"Slovak Republic",
                           country=="Saint Lucia"~"St. Lucia",
                           country=="Kyrgyzstan"~"Krygyz Republic",
                           country=="Micronesia"~"Micronesia, Fed. Sts.",
                           country=="Swaziland"~"Eswatini",
                           country=="Virgin Islands"~"Virgin Islands (U.S.)",
                        TRUE~country))
```

For the next group of cases, which Haslam refers to as the "island nations," we will need to aggregate the previously separated regions of Antigua and Barbuda, St. Kitts and Nevis, Trinidad and Tobago, and St. Vincent and the Grenadines using the following:

```{r}
island_nations <- c("Antigua","Barbuda","Nevis", 
                 "Saint Kitts","Trinidad",
                 "Tobago","Grenadines","Saint Vincent")
island_nations_match <- shapefile_data %>% 
  filter(country %in% island_nations)
island_nations_match %>% distinct(country)
ant_bar <- c(137,138 )
kit_nev <- c(930,931)
tri_tog <- c(1425,1426)
vin_gre <- c(1575,1576,1577)
island_nation_names <- c("Antigua and Barbuda","St. Kitts and Nevis","Trinidad and Tobago","St. Vincent and the Grenadines")
island_nations_match <- island_nations_match %>% 
  mutate(country=case_when(group %in% ant_bar~"Antigua and Barbuda",
                           group %in% kit_nev~"St. Kitts and Nevis",
                           group %in% tri_tog~"Trinidad and Tobago",
                           group %in% vin_gre~"St. Vincent and the Grenadines")) %>% 
  tibble()
island_nations_match %>%
  distinct(country) 
shapefile_data <- shapefile_data %>%
  filter(!country %in% island_nation_names)
shapefile_data <- shapefile_data %>% 
  bind_rows(island_nations_match) %>%
  arrange(country) %>%
  tibble()
```

Now, we move on to the final two cases pertinent to our impact model, which Haslam refers to as "subregion promotion." In the case of the special administrative regions of Hong Kong and Macao, the `maps` package organizes these states as subregions within its country-classification scheme. While this is politically correct, economic and health data from these regions, as Haslam (2021) points out, are often collected and presented separately from that of mainland China. 

In following this practice, we therefore need to adjust this organizational framework to reflect our desire to treat these regions as country-level entities using the naming conventions prescribed by the ISO. We accomplish this using the following: 

```{r}
sra_names <- c("Hong Kong","Macao")
hk_mc <- shapefile_data %>% 
  filter(subregion %in% sra_names)
hk_mc <- hk_mc %>%
  mutate(country = case_when(subregion=="Hong Kong"~"Hong Kong, China",
                             subregion=="Macao"~"Macao, China"))
shapefile_data <- shapefile_data %>%
  filter(!subregion %in% sra_names)
shapefile_data <- shapefile_data %>% 
  bind_rows(hk_mc) %>%
  select(-subregion) %>% 
  tibble()
```

With these steps complete, we can now review the countries currently accounted for in our shape-file data.

```{r}
shapefile_data %>% distinct(country)
```

## Adjusting the Dietary-Footprint Data

In preparation for our spatial join, we will need to reformat the dietary-footprint data to suit the needs of our analysis. 

We'll begin, first, by selecting the following variables for extraction: `country`, `diet`, `attribute`, `value`.

```{r}
dietary_footprint_data <- dietary_footprint_data %>%
  select(country,diet,attribute,value,centile_down,centile_up)
```

With this accomplished, we can now continue the wrangling process by pivoting the tibble to a wider format, allowing each row to correspond to a unique country and each column to map on to the indicator-specific values and centiles for each dietary pattern.

```{r}
dietary_footprint_data <- dietary_footprint_data %>%
  pivot_wider(names_from=c(diet,attribute),
              values_from=c(value,centile_up,centile_down))
```

Now that the data is organized in this way, we can sort through the newly generated columns and limit the dataset to the specific combinations of dietary patterns and sustainability indicators that are appropraite for our analyses. More specifically, we want to extract the `kg_co2e_excl_luc`, `kg_co2e_total`, `l_blue_green_wf`, and `l_blue_wf_total` indicators for the baseline, meatless day, low red meat, no dairy, no red meat, vegetarian, and vegan diets. ### would be good to add EAT-Lancet diet.

```{r}
dietary_footprint_data <- dietary_footprint_data %>% select(country,
                                                            centile_down_baseline_kg_co2e_excl_luc,value_baseline_kg_co2e_excl_luc,centile_up_baseline_kg_co2e_excl_luc,centile_down_baseline_kg_co2e_total,value_baseline_kg_co2e_total,centile_up_baseline_kg_co2e_total,centile_down_baseline_l_blue_green_wf,value_baseline_l_blue_green_wf,centile_up_baseline_l_blue_green_wf,centile_down_baseline_l_blue_wf_total,value_baseline_l_blue_wf_total,centile_up_baseline_l_blue_wf_total,
                                                            centile_down_meatless_day_kg_co2e_excl_luc,value_meatless_day_kg_co2e_excl_luc,centile_up_meatless_day_kg_co2e_excl_luc,centile_down_meatless_day_kg_co2e_total,value_meatless_day_kg_co2e_total,centile_up_meatless_day_kg_co2e_total,centile_down_meatless_day_l_blue_green_wf,value_meatless_day_l_blue_green_wf,centile_up_meatless_day_l_blue_green_wf,centile_down_meatless_day_l_blue_wf_total,value_meatless_day_l_blue_wf_total,centile_up_meatless_day_l_blue_wf_total,
                                                            centile_down_low_red_meat_kg_co2e_excl_luc,value_low_red_meat_kg_co2e_excl_luc,centile_up_low_red_meat_kg_co2e_excl_luc,centile_down_low_red_meat_kg_co2e_total,value_low_red_meat_kg_co2e_total,centile_up_low_red_meat_kg_co2e_total,centile_down_low_red_meat_l_blue_green_wf,value_low_red_meat_l_blue_green_wf,centile_up_low_red_meat_l_blue_green_wf,centile_down_low_red_meat_l_blue_wf_total,value_low_red_meat_l_blue_wf_total,centile_up_low_red_meat_l_blue_wf_total,
                                                            centile_down_no_dairy_kg_co2e_excl_luc,value_no_dairy_kg_co2e_excl_luc,centile_up_no_dairy_kg_co2e_excl_luc,centile_down_no_dairy_kg_co2e_total,value_no_dairy_kg_co2e_total,centile_up_no_dairy_kg_co2e_total,centile_down_no_dairy_l_blue_green_wf,value_no_dairy_l_blue_green_wf,centile_up_no_dairy_l_blue_green_wf,centile_down_no_dairy_l_blue_wf_total,value_no_dairy_l_blue_wf_total,centile_up_no_dairy_l_blue_wf_total,
                                                            centile_down_no_red_meat_kg_co2e_excl_luc,value_no_red_meat_kg_co2e_excl_luc,centile_up_no_red_meat_kg_co2e_excl_luc,centile_down_no_red_meat_kg_co2e_total,value_no_red_meat_kg_co2e_total,centile_up_no_red_meat_kg_co2e_total,centile_down_no_red_meat_l_blue_green_wf,value_no_red_meat_l_blue_green_wf,centile_up_no_red_meat_l_blue_green_wf,centile_down_no_red_meat_l_blue_wf_total,value_no_red_meat_l_blue_wf_total,centile_up_no_red_meat_l_blue_wf_total,
                                                            centile_down_lacto_ovo_vegetarian_kg_co2e_excl_luc,value_lacto_ovo_vegetarian_kg_co2e_excl_luc,centile_up_lacto_ovo_vegetarian_kg_co2e_excl_luc,centile_down_lacto_ovo_vegetarian_kg_co2e_total,value_lacto_ovo_vegetarian_kg_co2e_total,centile_up_lacto_ovo_vegetarian_kg_co2e_total,centile_down_lacto_ovo_vegetarian_l_blue_green_wf,value_lacto_ovo_vegetarian_l_blue_green_wf,centile_up_lacto_ovo_vegetarian_l_blue_green_wf,centile_down_lacto_ovo_vegetarian_l_blue_wf_total,value_lacto_ovo_vegetarian_l_blue_wf_total,centile_up_lacto_ovo_vegetarian_l_blue_wf_total,
                                                            centile_down_vegan_kg_co2e_excl_luc,value_vegan_kg_co2e_excl_luc,centile_up_vegan_kg_co2e_excl_luc,centile_down_vegan_kg_co2e_total,value_vegan_kg_co2e_total,centile_up_vegan_kg_co2e_total,centile_down_vegan_l_blue_green_wf,value_vegan_l_blue_green_wf,centile_up_vegan_l_blue_green_wf,centile_down_vegan_l_blue_wf_total,value_vegan_l_blue_wf_total,centile_up_vegan_l_blue_wf_total)
```

### RUNNNING THIS BACK WITH EAT-LANCET/NO WATER

Here, in the interest of adding the annual per capita emissions estimates associated with the EAT-Lancet diet, we need to align the existing dietary-footprint data from Kim and colleagues (2020) with the more recently reworked data from Semba et al (2020).

In order to accomplish this, we will need to make a couple of changes before joining the two datasets. The object, here, is to match the language of the two data sources, such that they resemble structure and use the same language to represent the same constructs. 

The data associated with the latter publication focuses only on the total annual per capita greenhouse gas emissions (in kilograms) and represents this indicator within the `attribute` column as `per_capita_kg_co2e`. This same indicator is represented in the original source under the `attribute` column as `kg_co2e_total`.

We can therefore transform the original data source from Kim and colleagues (2020) to force alignment on this convention in preparation for our join. 

```{r}
climate_footprint_data <- climate_footprint_data %>% mutate(attribute=str_replace_all(attribute,"kg_co2e_total","per_capita_kg_co2e"))
```

Now that this is complete, we can select out the relevant columns for our analyses. Because there is no centile data available in the associated data for "Adoption of the 'planetary health diet' has different impacts on countries' greenhouse gas emissions," we no longer need to extract the `centile_up` and `centile_down` columns.

```{r}
climate_footprint_data <- climate_footprint_data %>%
  select(country_code,country,diet,attribute,value)
```

Now that the relevant columns are represented in the same way across the two dietary-footprint data sources, we can read in the companion data source and extract the relevant columns, as we did before. 

```{r}
planetary_health_emissions_data <- read.csv("/Users/kenjinchang/github/university-impact-model/data/parent-files/planetary_health_emissions_by_country.csv") %>% select(country_code,country,diet,attribute,value)
```

We can see that, while the column names are the same across the two data sets, the `value` columns are represented differently, with one being represented as a character string and the other represented as a double vector. 

This difference is a product of the 1,000-separating commas used in the updated dataset. To remove this, and convert the column structure, we do the following:

```{r}
planetary_health_emissions_data <- planetary_health_emissions_data %>% 
  mutate_all(~sub(",", "", .)) %>% mutate(value=as.double(value)) %>% mutate(country_code=as.integer(country_code))
```

Before performing our bind, there are still some checks that need to be done. We know that there are 140 countries represented in `climate_footprint_data` to the 151 in `planetary_health_emissions_data`.

```{r}
climate_footprint_data %>% distinct(country) %>% count()
```

```{r}
planetary_health_emissions_data %>% distinct(country) %>% count()
```

Using filtering joins, we can quickly find out (1) the countries that are represented in `climate_footprint_data` without a 1:1 match in `planetary_health_emissions_data`, as well as (2) the countries that are represented in `planetary_health_emissions_data` without a 1:1 match in `climate_footprint_data`.

```{r}
anti_join(climate_footprint_data,planetary_health_emissions_data,by="country") %>%
  distinct(country)
```


```{r}
anti_join(planetary_health_emissions_data,climate_footprint_data,by="country") %>% distinct(country)
```

Before binding these two data sources together, we need to first ensure that the countries are named the same

```{r}
test <- bind_rows(planetary_health_emissions_data,climate_footprint_data)
```


## Adjusting the University-Enrollment Data


```{r}
impact_data <- read.csv("/Users/kenjinchang/github/university-impact-model/data/parent-files/dietary_footprints_by_country.csv")
dietary_footprint_data %>% head(6)
```


```{r}
write.csv(impact_data,"~/github/university-impact-model/data/model-output/impact-data.csv")
```

